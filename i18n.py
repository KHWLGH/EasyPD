"""Internationalization helpers for EasyPD."""

from __future__ import annotations

from typing import Any, Dict

DEFAULT_LANGUAGE = "zh"

SUPPORTED_LANGUAGES = [
    ("zh", "中文"),
    ("en", "English"),
]

LANG_STRINGS: Dict[str, Dict[str, str]] = {
    "zh": {
        "app_title": "EasyPD",
        "checkbox_data_visualization": "数据可视化",
        "chart_title": "测量数据",
        "chart_axis_x": "相对时间 (秒)",
        "chart_axis_y": "数值 (多单位)",
        "chart_voltage": "电压 (V)",
        "chart_current": "电流 (A)",
        "chart_power": "功率 (W)",
        "label_device": "设备:",
        "label_language": "语言:",
        "btn_refresh_devices": "刷新设备",
        "btn_connect": "连接设备",
        "btn_disconnect": "断开设备",
        "btn_start": "开始收集",
        "btn_pause": "暂停收集",
        "btn_resume": "继续收集",
        "btn_clear": "清空记录",
        "btn_export": "导出 CSV",
        "btn_import": "导入 CSV",
        "checkbox_auto_scroll": "自动滚动",
        "status_disconnected": "未连接",
        "status_connected": "已连接",
        "status_collecting": "收集中...",
        "status_paused": "已暂停",
        "records_count": "记录: {count}",
        "status_records_zero": "记录: 0",
        "device_auto": "自动选择",
        "device_fallback_label": "设备 {index}",
        "device_selector_unavailable": "HID 库不可用",
        "hid_unavailable": "HID 库不可用，无法连接设备",
        "tooltip_manufacturer": "厂家: {manufacturer}",
        "tooltip_product": "产品: {product}",
        "tooltip_serial": "序列号: {serial}",
        "tooltip_path": "路径: {path}",
        "language_switch_tooltip": "切换至 {language}",
        "tooltip_default_vidpid": "默认 VID:PID = {vid:04X}:{pid:04X}",
        "tooltip_vid_pid": "VID:PID = {vid:04X}:{pid:04X}",
        "tooltip_voltage": "电压 (V)",
        "tooltip_current": "电流 (A)",
        "tooltip_power": "功率 (W)",
        "measurement_display": "{value:.3f} {unit}",
        "dialog_clear_existing": "检测到已有记录，重新连接前需要清空数据。是否清空？",
        "dialog_clear_existing_title": "清空记录",
        "dialog_confirm_clear": "确定要清空所有记录吗?",
        "dialog_confirm_title": "确认",
        "dialog_manual_clear": "此操作将立即清空所有记录且不可恢复，是否继续?",
        "dialog_manual_clear_title": "清空记录",
        "dialog_warning_title": "警告",
        "dialog_error_title": "错误",
        "dialog_info_title": "提示",
        "dialog_question_title": "询问",
        "dialog_export_title": "导出 CSV",
        "dialog_import_title": "导入 CSV",
        "dialog_export_no_records": "没有可导出的记录",
        "dialog_export_success": "成功导出 {count} 条记录",
        "dialog_export_success_title": "成功",
        "dialog_export_failed": "导出失败: {error}",
        "dialog_import_success": "成功导入 {count} 条记录",
        "dialog_import_success_title": "成功",
        "dialog_import_failed": "导入失败: {error}",
        "file_filter_csv": "CSV 文件 (*.csv);;所有文件 (*.*)",
        "csv_header_index": "序号",
        "csv_header_absolute_time": "绝对时间",
        "csv_header_relative_time": "相对时间(秒)",
        "csv_header_type": "类型",
        "csv_header_summary": "摘要",
        "csv_header_details": "详细数据",
        "pdo_title": "当前 PDO 列表",
        "pdo_column_index": "序号",
        "pdo_column_description": "描述",
        "detail_title": "详细信息",
        "records_title": "PD 记录列表",
        "cable_title": "线缆信息 (VDM)",
        "cable_column_field": "字段",
        "cable_column_value": "值",
        "table_column_index": "序号",
        "table_column_relative_time": "相对时间(秒)",
        "table_column_type": "类型",
        "table_column_summary": "摘要",
        "detail_index": "序号",
        "detail_time": "时间",
        "detail_relative_time": "相对时间",
        "detail_relative_seconds": "{seconds:.3f} 秒",
        "detail_type": "类型",
        "detail_summary": "摘要",
        "detail_pdo_header": "PDO 详细信息:",
        "detail_rdo_header": "RDO 详细信息:",
        "detail_raw": "原始数据",
        "detail_extra": "详情",
        "measurement_count": "测量: {count}",
        "error_device_disconnected": "设备已断开连接",
        "error_connection_failed": "连接失败: {detail}",
        "error_connection_failed_generic": "连接失败",
        "language_option_zh": "中文",
        "language_option_en": "English",
        "detail_separator_seconds": "秒",
        "dialog_import_filter": "CSV 文件 (*.csv);;所有文件 (*.*)",
        "status_idle": "未连接",
        "log_get_devices_failed": "获取设备列表失败: {detail}",
        "log_skip_invalid_row": "跳过无效行: {detail}",
        "checkbox_auto_pause_threshold": "启用自动暂停",
        "btn_auto_pause_settings": "自动暂停",
        "dialog_threshold_title": "自动暂停设置",
        "label_voltage_threshold": "电压阈值 (V):",
        "label_current_threshold": "电流阈值 (A):",
        "label_auto_pause_metric": "监控项目:",
        "auto_pause_metric_voltage": "电压",
        "auto_pause_metric_current": "电流",
        "label_auto_pause_delay": "延时停止 (秒):",
        "threshold_settings_hint": "选择监控项目，当其低于阈值并达到延时后自动暂停收集",
        "tooltip_voltage_threshold": "0-20V，可输入小数",
        "tooltip_current_threshold": "0-5A，可输入小数",
        "tooltip_auto_pause_delay": "0-10 秒，0 表示立即暂停",
        "auto_pause_status_tooltip": "点击确定后自动暂停设置才会生效",
        "auto_pause_status_disabled": "自动暂停: 禁用",
        "auto_pause_status_enabled": "自动暂停: V<{voltage}V 或 I<{current}A",
        "auto_pause_status_enabled_single": "自动暂停: {metric}<{threshold}{unit}{delay_text}",
        "auto_pause_status_delay_suffix": "，延时 {delay}s",
        "auto_pause_invalid_number": "请输入有效的数字",
        "auto_pause_voltage_range_warning": "电压阈值必须在 0-20V 范围内",
        "auto_pause_current_range_warning": "电流阈值必须在 0-5A 范围内",
        "auto_pause_delay_range_warning": "延时必须在 0-10 秒范围内",
        "auto_pause_settings_applied": "自动暂停设置已更新",
        "auto_pause_settings_disabled": "自动暂停已禁用",
        "auto_pause_settings_enabled_summary": "自动暂停: {metric}<{threshold}{unit}，延时 {delay}s",
        "auto_pause_triggered": "自动暂停触发: 电压/电流低于阈值",
        "auto_pause_triggered_with_value": "自动暂停触发: {metric} {value}{unit} < 阈值 {threshold}{unit}",
        "auto_pause_triggered_without_value": "自动暂停触发: {metric} 低于阈值 {threshold}{unit}",
    },
    "en": {
        "app_title": "EasyPD",
        "checkbox_data_visualization": "Data Visualization",
        "chart_title": "Measurement Data",
        "chart_axis_x": "Relative Time (seconds)",
        "chart_axis_y": "Values (multiple units)",
        "chart_voltage": "Voltage (V)",
        "chart_current": "Current (A)",
        "chart_power": "Power (W)",
        "label_device": "Device:",
        "label_language": "Language:",
        "btn_refresh_devices": "Refresh Devices",
        "btn_connect": "Connect",
        "btn_disconnect": "Disconnect",
        "btn_start": "Start Capture",
        "btn_pause": "Pause Capture",
        "btn_resume": "Resume Capture",
        "btn_clear": "Clear Records",
        "btn_export": "Export CSV",
        "btn_import": "Import CSV",
        "checkbox_auto_scroll": "Auto Scroll",
        "status_disconnected": "Disconnected",
        "status_connected": "Connected",
        "status_collecting": "Capturing...",
        "status_paused": "Paused",
        "records_count": "Records: {count}",
        "status_records_zero": "Records: 0",
        "device_auto": "Auto Select",
        "device_fallback_label": "Device {index}",
        "device_selector_unavailable": "HID library unavailable",
        "hid_unavailable": "HID library unavailable. Unable to connect.",
        "tooltip_manufacturer": "Manufacturer: {manufacturer}",
        "tooltip_product": "Product: {product}",
        "tooltip_serial": "Serial: {serial}",
        "tooltip_path": "Path: {path}",
        "language_switch_tooltip": "Switch to {language}",
        "tooltip_default_vidpid": "Default VID:PID = {vid:04X}:{pid:04X}",
        "tooltip_vid_pid": "VID:PID = {vid:04X}:{pid:04X}",
        "tooltip_voltage": "Voltage (V)",
        "tooltip_current": "Current (A)",
        "tooltip_power": "Power (W)",
        "measurement_display": "{value:.3f} {unit}",
        "dialog_clear_existing": "Existing records detected. Clear data before reconnecting?",
        "dialog_clear_existing_title": "Clear Records",
        "dialog_confirm_clear": "Clear all records?",
        "dialog_confirm_title": "Confirm",
        "dialog_manual_clear": "This will erase all records immediately and cannot be undone. Continue?",
        "dialog_manual_clear_title": "Clear Records",
        "dialog_warning_title": "Warning",
        "dialog_error_title": "Error",
        "dialog_info_title": "Info",
        "dialog_question_title": "Question",
        "dialog_export_title": "Export CSV",
        "dialog_import_title": "Import CSV",
        "dialog_export_no_records": "No records available for export.",
        "dialog_export_success": "Exported {count} records successfully.",
        "dialog_export_success_title": "Success",
        "dialog_export_failed": "Export failed: {error}",
        "dialog_import_success": "Imported {count} records successfully.",
        "dialog_import_success_title": "Success",
        "dialog_import_failed": "Import failed: {error}",
        "file_filter_csv": "CSV Files (*.csv);;All Files (*.*)",
        "csv_header_index": "Index",
        "csv_header_absolute_time": "Absolute Time",
        "csv_header_relative_time": "Relative Time (s)",
        "csv_header_type": "Type",
        "csv_header_summary": "Summary",
        "csv_header_details": "Details",
        "pdo_title": "Current PDOs",
        "pdo_column_index": "Index",
        "pdo_column_description": "Description",
        "detail_title": "Details",
        "records_title": "PD Records",
        "cable_title": "Cable Info (VDM)",
        "cable_column_field": "Field",
        "cable_column_value": "Value",
        "table_column_index": "Index",
        "table_column_relative_time": "Relative Time (s)",
        "table_column_type": "Type",
        "table_column_summary": "Summary",
        "detail_index": "Index",
        "detail_time": "Time",
        "detail_relative_time": "Relative Time",
        "detail_relative_seconds": "{seconds:.3f} s",
        "detail_type": "Type",
        "detail_summary": "Summary",
        "detail_pdo_header": "PDO Details:",
        "detail_rdo_header": "RDO Details:",
        "detail_raw": "Raw",
        "detail_extra": "Notes",
        "measurement_count": "Measurements: {count}",
        "error_device_disconnected": "Device disconnected.",
        "error_connection_failed": "Connection failed: {detail}",
        "error_connection_failed_generic": "Connection failed.",
        "language_option_zh": "中文",
        "language_option_en": "English",
        "detail_separator_seconds": "s",
        "dialog_import_filter": "CSV Files (*.csv);;All Files (*.*)",
        "status_idle": "Disconnected",
        "log_get_devices_failed": "Failed to enumerate devices: {detail}",
        "log_skip_invalid_row": "Skipped invalid row: {detail}",
        "checkbox_auto_pause_threshold": "Enable Auto Pause",
        "btn_auto_pause_settings": "Auto Pause",
        "dialog_threshold_title": "Auto Pause Settings",
        "label_voltage_threshold": "Voltage Threshold (V):",
        "label_current_threshold": "Current Threshold (A):",
        "label_auto_pause_metric": "Monitored Channel:",
        "auto_pause_metric_voltage": "Voltage",
        "auto_pause_metric_current": "Current",
        "label_auto_pause_delay": "Delay Before Pause (s):",
        "threshold_settings_hint": "Pick one channel; capture pauses when it stays below the threshold for the configured delay",
        "tooltip_voltage_threshold": "0-20V, decimals allowed",
        "tooltip_current_threshold": "0-5A, decimals allowed",
        "tooltip_auto_pause_delay": "0-10s, 0 means pause immediately",
        "auto_pause_status_tooltip": "Auto pause changes are applied after confirming with OK",
        "auto_pause_status_disabled": "Auto Pause: Disabled",
        "auto_pause_status_enabled": "Auto Pause: V<{voltage}V or I<{current}A",
        "auto_pause_status_enabled_single": "Auto Pause: {metric}<{threshold}{unit}{delay_text}",
        "auto_pause_status_delay_suffix": ", delay {delay}s",
        "auto_pause_invalid_number": "Please enter valid numbers.",
        "auto_pause_voltage_range_warning": "Voltage threshold must be between 0 and 20V.",
        "auto_pause_current_range_warning": "Current threshold must be between 0 and 5A.",
        "auto_pause_delay_range_warning": "Delay must be between 0 and 10 seconds.",
        "auto_pause_settings_applied": "Auto pause settings updated.",
        "auto_pause_settings_disabled": "Auto pause disabled.",
        "auto_pause_settings_enabled_summary": "Auto pause: {metric}<{threshold}{unit}, delay {delay}s",
        "auto_pause_triggered": "Auto pause triggered: Voltage/Current below threshold",
        "auto_pause_triggered_with_value": "Auto pause triggered: {metric} {value}{unit} < threshold {threshold}{unit}",
        "auto_pause_triggered_without_value": "Auto pause triggered: {metric} below threshold {threshold}{unit}",
    },
}

CABLE_FIELD_TEXT: Dict[str, Dict[str, str]] = {
    "cable_svid": {"zh": "SVID", "en": "SVID"},
    "cable_source": {"zh": "来源", "en": "Source"},
    "cable_command": {"zh": "命令", "en": "Command"},
    "cable_vendor_id": {"zh": "厂商 VID", "en": "Vendor VID"},
    "cable_role": {"zh": "线缆角色", "en": "Cable Role"},
    "cable_product_id": {"zh": "产品 ID", "en": "Product ID"},
    "cable_device_version": {"zh": "设备版本", "en": "Device Version"},
    "cable_type": {"zh": "线缆类型", "en": "Cable Type"},
    "cable_connector": {"zh": "连接器", "en": "Connector"},
    "cable_termination": {"zh": "终端类型", "en": "Termination"},
    "cable_max_voltage": {"zh": "最大电压", "en": "Max Voltage"},
    "cable_current": {"zh": "电流能力", "en": "Current Capability"},
    "cable_highest_speed": {"zh": "最高速率", "en": "Highest Speed"},
    "cable_latency": {"zh": "线缆延迟", "en": "Latency"},
    "cable_supports_epr": {"zh": "支持 EPR", "en": "EPR Support"},
    "cable_sbu": {"zh": "SBU 线路", "en": "SBU Lines"},
    "cable_max_temp": {"zh": "最高工作温度", "en": "Max Operating Temp"},
    "cable_shutdown_temp": {"zh": "关断温度", "en": "Shutdown Temp"},
    "cable_usb4": {"zh": "USB4 支持", "en": "USB4 Support"},
    "cable_charge_through": {"zh": "支持穿透供电", "en": "Charge-Through Support"},
    "cable_charge_through_current": {"zh": "穿透电流能力", "en": "Charge-Through Current"},
    "cable_vbus_impedance": {"zh": "VBUS 阻抗", "en": "VBUS Impedance"},
    "cable_ground_impedance": {"zh": "地线阻抗", "en": "Ground Impedance"},
}

CABLE_VALUE_TEXT: Dict[str, Dict[str, str]] = {
    "cable_type_passive": {"zh": "被动线缆", "en": "Passive Cable"},
    "cable_type_active": {"zh": "主动线缆", "en": "Active Cable"},
    "cable_type_vpd": {"zh": "VCONN 供电设备", "en": "VCONN Powered Device"},
    "bool_true": {"zh": "是", "en": "Yes"},
    "bool_false": {"zh": "否", "en": "No"},
}


def get_text(language: str, key: str, **kwargs: Any) -> str:
    """Return the localized string for the given language and key."""
    language_map = LANG_STRINGS.get(language, LANG_STRINGS[DEFAULT_LANGUAGE])
    fallback_map = LANG_STRINGS[DEFAULT_LANGUAGE]
    text = language_map.get(key, fallback_map.get(key, key))
    if kwargs:
        try:
            text = text.format(**kwargs)
        except Exception:
            pass
    return text


def get_language_option(current_language: str, code: str) -> str:
    """Return the localized language name for the given code."""
    lang_map = LANG_STRINGS.get(current_language, LANG_STRINGS[DEFAULT_LANGUAGE])
    key = f"language_option_{code}"
    if key in lang_map:
        return lang_map[key]
    fallback = LANG_STRINGS[DEFAULT_LANGUAGE]
    return fallback.get(key, code)


def translate_cable_field(language: str, key: str) -> str:
    return CABLE_FIELD_TEXT.get(key, {}).get(language, key)


def translate_cable_value(language: str, value: Any) -> str:
    if value is None:
        return ""
    if isinstance(value, str) and value in CABLE_VALUE_TEXT:
        return CABLE_VALUE_TEXT[value].get(language, value)
    if isinstance(value, str):
        if value == "bool_true":
            return CABLE_VALUE_TEXT["bool_true"].get(language, "Yes")
        if value == "bool_false":
            return CABLE_VALUE_TEXT["bool_false"].get(language, "No")
        return value
    return str(value)


__all__ = [
    "DEFAULT_LANGUAGE",
    "SUPPORTED_LANGUAGES",
    "LANG_STRINGS",
    "CABLE_FIELD_TEXT",
    "CABLE_VALUE_TEXT",
    "get_text",
    "get_language_option",
    "translate_cable_field",
    "translate_cable_value",
]
